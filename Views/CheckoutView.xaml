<UserControl
    x:Class="LuxuryCarRental.Views.CheckoutView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    mc:Ignorable="d"
    d:DesignHeight="450"
    d:DesignWidth="800">

    <!-- DataContext is set in code‐behind via DI -->

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- Date pickers -->
            <RowDefinition Height="Auto"/>
            <!-- Cart items -->
            <RowDefinition Height="Auto"/>
            <!-- Payment section -->
            <RowDefinition Height="*"/>
            <!-- Spacer -->
            <RowDefinition Height="Auto"/>
            <!-- Pay button -->
        </Grid.RowDefinitions>

        <!-- 1) Date pickers -->
        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="Start Date:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <DatePicker
                SelectedDate="{Binding StartDate, Mode=TwoWay}"
                DisplayDateStart="{x:Static sys:DateTime.Today}"
                Width="120"
                Margin="0,0,16,0"/>
            <TextBlock Text="End Date:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <DatePicker
                SelectedDate="{Binding EndDate, Mode=TwoWay}"
                DisplayDateStart="{Binding StartDate}"
                Width="120"
                Margin="0,0,16,0"/>
            <TextBlock Text="Duration:" VerticalAlignment="Center" Margin="0,0,8,0"/>
            <TextBlock Text="{Binding DurationDays}" VerticalAlignment="Center" Margin="0,0,4,0"/>
            <TextBlock Text="days" VerticalAlignment="Center"/>
        </StackPanel>

        <!-- 2) Cart items DataGrid -->
        <DataGrid
            Grid.Row="1"
            ItemsSource="{Binding CartItems}"
            AutoGenerateColumns="False"
            CanUserAddRows="False"
            IsReadOnly="True"
            Margin="0,0,0,16"
            RowHeight="30">
            <DataGrid.Columns>
                <DataGridTextColumn
                    Header="Vehicle"
                    Binding="{Binding Vehicle.Make}"
                    Width="*" />
                <DataGridTextColumn
                    Header="Model"
                    Binding="{Binding Vehicle.Model}"
                    Width="*" />
                <DataGridTextColumn
                    Header="Start"
                    Binding="{Binding StartDate, StringFormat=d}"
                    Width="Auto" />
                <DataGridTextColumn
                    Header="End"
                    Binding="{Binding EndDate, StringFormat=d}"
                    Width="Auto" />
                <DataGridTextColumn
                    Header="Subtotal"
                    Binding="{Binding Subtotal, StringFormat=C}"
                    Width="Auto" />
            </DataGrid.Columns>
        </DataGrid>

        <!-- 3) PAYMENT SECTION -->
        <StackPanel Grid.Row="2" Orientation="Vertical" Margin="0,0,0,16">
            <!-- 3a) Use Saved Card -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                <TextBlock Text="Use Saved Card:" VerticalAlignment="Center"/>
                <ComboBox
                        ItemsSource="{Binding SavedCards}"
                        DisplayMemberPath="Nickname"
                        SelectedItem="{Binding SelectedSavedCard, Mode=TwoWay}"
                        IsSynchronizedWithCurrentItem="False"
                        SelectedIndex="-1"                 
                                        Width="200"
                        Margin="8,0,0,0"/>
                    <TextBlock
                    Text="(optional)"
                    VerticalAlignment="Center"
                    FontStyle="Italic"
                    Foreground="Gray"
                    Margin="8,0,0,0"/>
            </StackPanel>

            <!-- 3b) Remember this card -->
            <CheckBox
                Content="Remember this card"
                IsChecked="{Binding RememberCard, Mode=TwoWay}"
                Margin="0,0,0,8"/>

            <!-- 3c) Manual entry fields: bind IsEnabled to CanEditCard -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                <TextBlock
                    Text="Card #:" VerticalAlignment="Center" Width="80"/>
                <TextBox
                    Width="120"
                    Text="{Binding CardNumber, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    IsEnabled="{Binding CanEditCard}"
                    Margin="0,0,8,0"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                <TextBlock
                    Text="Expiry (MM/YY):" VerticalAlignment="Center" Width="80"/>
                <TextBox
                    Width="80"
                    Text="{Binding Expiry, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    IsEnabled="{Binding CanEditCard}"
                    Margin="0,0,8,0"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal">
                <TextBlock
                    Text="CVV:" VerticalAlignment="Center" Width="80"/>
                <TextBox
                    Width="60"
                    Text="{Binding Cvv, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    IsEnabled="{Binding CanEditCard}"/>
            </StackPanel>
        </StackPanel>

        <!-- 4) Spacer -->
        <Grid Grid.Row="3"/>

        <!-- 5) Error message + Confirm & Pay button -->
        <StackPanel Grid.Row="4" Orientation="Vertical" Margin="0,12,0,0">

            <!--
              A TextBlock whose Style collapses it when ErrorMessage is null or empty.
              By default we set Visibility=Visible, then use DataTriggers to collapse
              when the underlying string is either "" or null.
            -->
            <TextBlock
                Text="{Binding ErrorMessage}"
                Foreground="Red"
                Margin="0,0,0,8">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <!-- default is to show it -->
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <!-- if ErrorMessage == "" (empty), collapse -->
                            <DataTrigger Binding="{Binding ErrorMessage}" Value="">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                            <!-- if ErrorMessage is null, also collapse -->
                            <DataTrigger Binding="{Binding ErrorMessage}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <!-- Confirm & Pay button -->
            <Button
                Content="Confirm &amp; Pay"
                Command="{Binding PayCommand}"
                HorizontalAlignment="Right"
                Padding="8,4"/>
        </StackPanel>
    </Grid>
</UserControl>
